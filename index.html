<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- NO CACHE - for development iteration -->
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="expires" content="0" />
    <title>Malifaux 4E Card Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-family: 'Cinzel', serif;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            border-bottom: 2px solid #c9a227;
            padding: 1rem 2rem;
        }

            .header h1 {
                color: #c9a227;
                font-size: 1.8rem;
            }

        .header-sub {
            color: #888;
            font-size: 0.9rem;
        }

        /* Controls */
        .controls {
            background: #16213e;
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.6rem 1rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            font-size: 1rem;
        }

            .search-box:focus {
                outline: none;
                border-color: #c9a227;
            }

        .filter-select {
            padding: 0.6rem 1rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .result-count {
            color: #888;
            font-size: 0.9rem;
            min-width: 80px;
        }

        /* Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            flex: 1;
        }

        .card {
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #333;
        }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 24px rgba(201, 162, 39, 0.2);
                border-color: #c9a227;
            }

        .card-image {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            background: #111;
        }

        .card-info {
            padding: 1rem;
        }

        .card-name {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: #c9a227;
            margin-bottom: 0.5rem;
        }

        .card-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .card-faction {
            color: #aaa;
        }

        .card-stats {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .stat {
            background: #1a1a2e;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            border: 1px solid #444;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

            .modal-overlay.hidden {
                display: none;
            }

        .modal {
            background: #16213e;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #c9a227;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .modal-header h2 {
                color: #c9a227;
            }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

            .close-btn:hover {
                color: #fff;
            }

        .modal-body {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 700px) {
            .modal-body {
                grid-template-columns: 1fr;
            }
        }

        .modal-images {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .image-tabs {
            display: flex;
            gap: 0.5rem;
        }

            .image-tabs button {
                padding: 0.5rem 1rem;
                background: #1a1a2e;
                border: 1px solid #444;
                color: #888;
                cursor: pointer;
                border-radius: 4px;
            }

                .image-tabs button.active {
                    background: #c9a227;
                    color: #000;
                    border-color: #c9a227;
                }

        .modal-image {
            width: 100%;
            border-radius: 8px;
        }

        .modal-details h3 {
            color: #c9a227;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .modal-details section {
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .stat-box {
            background: #1a1a2e;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #444;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
        }

        .stat-value {
            font-size: 1.2rem;
            color: #c9a227;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .keyword-tag {
            background: #1a1a2e;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #444;
        }

            .keyword-tag.characteristic {
                border-color: #c9a227;
                color: #c9a227;
            }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #888;
            flex: 1;
        }

        /* Empty State */
        .empty {
            text-align: center;
            padding: 4rem;
            color: #888;
        }

            .empty h3 {
                margin-bottom: 0.5rem;
            }

        /* Debug banner - remove in production */
        .debug-banner {
            background: #4a1;
            color: #000;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Debug banner - shows version to confirm cache is cleared -->
        <div class="debug-banner">
            Build: <span id="build-time"></span> | Filters Active: <span id="debug-filters">none</span>
        </div>

        <header class="header">
            <h1>Malifaux 4E Database</h1>
            <p class="header-sub">Card Browser</p>
        </header>

        <div class="controls">
            <input type="text"
                   id="search-input"
                   class="search-box"
                   placeholder="Search cards or keywords..." />
            <select id="faction-select" class="filter-select">
                <option value="">All Factions</option>
            </select>
            <select id="base-size-select" class="filter-select">
                <option value="">All Base Sizes</option>
            </select>
            <span id="result-count" class="result-count">0 cards</span>
        </div>

        <div id="loading" class="loading">Loading cards...</div>
        <div id="empty" class="empty" style="display: none;">
            <h3>No cards found</h3>
            <p>Try adjusting your search or filters</p>
        </div>
        <div id="card-grid" class="card-grid"></div>

        <!-- Modal -->
        <div id="modal-overlay" class="modal-overlay hidden">
            <div class="modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2 id="modal-title">Card Name</h2>
                    <button class="close-btn" onclick="closeModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="modal-images">
                        <div class="image-tabs">
                            <button id="btn-front" class="active" onclick="setModalView('front')">Front</button>
                            <button id="btn-back" onclick="setModalView('back')">Back</button>
                        </div>
                        <img id="modal-image" class="modal-image" src="" alt="Card image" />
                    </div>
                    <div id="modal-details" class="modal-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // MALIFAUX 4E CARD DATABASE - VANILLA JS
        // ===========================================

        const IMAGE_BASE = 'https://raw.githubusercontent.com/profangrybeard/Malifaux4eDB-images/main';

        // State
        let allCards = [];
        let filteredCards = [];
        let selectedCard = null;
        let modalView = 'front';

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const factionSelect = document.getElementById('faction-select');
        const baseSizeSelect = document.getElementById('base-size-select');
        const resultCount = document.getElementById('result-count');
        const cardGrid = document.getElementById('card-grid');
        const loadingEl = document.getElementById('loading');
        const emptyEl = document.getElementById('empty');
        const modalOverlay = document.getElementById('modal-overlay');
        const debugFilters = document.getElementById('debug-filters');

        // Show build time in debug banner
        document.getElementById('build-time').textContent = new Date().toISOString();

        // ===========================================
        // FILTERING - THE CRITICAL PART
        // ===========================================

        function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedFaction = factionSelect.value;
        const selectedBaseSize = baseSizeSelect.value;

        // Debug output
        console.log('=== APPLYING FILTERS ===');
        console.log('Search:', searchTerm || '(none)');
        console.log('Faction:', selectedFaction || '(all)');
        console.log('Base Size:', selectedBaseSize || '(all)');
        console.log('Total cards before filter:', allCards.length);

        // Update debug banner
        const activeFilters = [];
        if (searchTerm) activeFilters.push(`search="${searchTerm}"`);
        if (selectedFaction) activeFilters.push(`faction="${selectedFaction}"`);
        if (selectedBaseSize) activeFilters.push(`base="${selectedBaseSize}"`);
        debugFilters.textContent = activeFilters.length ? activeFilters.join(', ') : 'none';

        // FILTER THE CARDS
        filteredCards = allCards.filter(card => {
        // Search filter
        if (searchTerm) {
        const nameMatch = card.name && card.name.toLowerCase().includes(searchTerm);
        const keywordMatch = card.keywords && card.keywords.some(k =>
        k.toLowerCase().includes(searchTerm)
        );
        if (!nameMatch && !keywordMatch) {
        return false;
        }
        }

        // Faction filter
        if (selectedFaction && card.faction !== selectedFaction) {
        return false;
        }

        // Base size filter
        if (selectedBaseSize && card.base_size !== selectedBaseSize) {
        return false;
        }

        return true;
        });

        console.log('Filtered cards:', filteredCards.length);
        console.log('First 3 filtered:', filteredCards.slice(0, 3).map(c => c.name));

        // UPDATE THE DISPLAY - THIS IS CRITICAL!
        renderCards();
        }

        // ===========================================
        // RENDERING
        // ===========================================

        function renderCards() {
        // Clear the grid
        cardGrid.innerHTML = '';

        // Update count
        resultCount.textContent = `${filteredCards.length} cards`;

        // Show/hide empty state
        if (filteredCards.length === 0) {
        emptyEl.style.display = 'block';
        cardGrid.style.display = 'none';
        } else {
        emptyEl.style.display = 'none';
        cardGrid.style.display = 'grid';

        // Render ONLY the filtered cards
        filteredCards.forEach(card => {
        const cardEl = createCardElement(card);
        cardGrid.appendChild(cardEl);
        });
        }

        console.log('Rendered', filteredCards.length, 'cards to DOM');
        }

        function createCardElement(card) {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => openModal(card);

        const imgSrc = card.front_image
        ? `${IMAGE_BASE}/${card.front_image}`
        : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23333" width="100" height="100"/><text x="50%" y="50%" fill="%23666" text-anchor="middle" dy=".3em">No Image</text></svg>';

        div.innerHTML = `
        <img
        class="card-image"
        src="${imgSrc}"
        alt="${card.name || 'Card'}"
        loading="lazy"
        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%%22 y=%2250%%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22>No Image</text></svg>'"
        />
        <div class="card-info">
        <h3 class="card-name">${card.name || 'Unknown'}</h3>
        <p class="card-meta">
        <span class="card-faction">${card.faction || ''}</span>
        ${card.subfaction ? ` • ${card.subfaction}` : ''}
        </p>
        ${card.cost ? `
        <div class="card-stats">
        <span class="stat">Cost: ${card.cost}</span>
        ${card.defense ? `<span class="stat">Df: ${card.defense}</span>` : ''}
        ${card.speed ? `<span class="stat">Sp: ${card.speed}</span>` : ''}
        </div>
        ` : ''}
        </div>
        `;

        return div;
        }

        // ===========================================
        // MODAL
        // ===========================================

        function openModal(card) {
        selectedCard = card;
        modalView = 'front';

        document.getElementById('modal-title').textContent = card.name || 'Unknown';
        updateModalImage();
        renderModalDetails(card);

        modalOverlay.classList.remove('hidden');
        document.getElementById('btn-front').classList.add('active');
        document.getElementById('btn-back').classList.remove('active');
        }

        function closeModal() {
        modalOverlay.classList.add('hidden');
        selectedCard = null;
        }

        function setModalView(view) {
        modalView = view;
        updateModalImage();

        document.getElementById('btn-front').classList.toggle('active', view === 'front');
        document.getElementById('btn-back').classList.toggle('active', view === 'back');
        }

        function updateModalImage() {
        if (!selectedCard) return;
        const imgField = modalView === 'front' ? selectedCard.front_image : selectedCard.back_image;
        const imgSrc = imgField ? `${IMAGE_BASE}/${imgField}` : '';
        document.getElementById('modal-image').src = imgSrc;
        }

        function renderModalDetails(card) {
        const details = document.getElementById('modal-details');

        let html = '<section><h3>Stats</h3><div class="stats-grid">';
        if (card.cost) html += `<div class="stat-box"><div class="stat-label">Cost</div><div class="stat-value">${card.cost}</div></div>`;
        if (card.defense) html += `<div class="stat-box"><div class="stat-label">Defense</div><div class="stat-value">${card.defense}</div></div>`;
        if (card.speed) html += `<div class="stat-box"><div class="stat-label">Speed</div><div class="stat-value">${card.speed}</div></div>`;
        if (card.willpower) html += `<div class="stat-box"><div class="stat-label">Willpower</div><div class="stat-value">${card.willpower}</div></div>`;
        if (card.size) html += `<div class="stat-box"><div class="stat-label">Size</div><div class="stat-value">${card.size}</div></div>`;
        if (card.health) html += `<div class="stat-box"><div class="stat-label">Health</div><div class="stat-value">${card.health}</div></div>`;
        html += '</div></section>';

        if (card.characteristics && card.characteristics.length > 0) {
        html += '<section><h3>Characteristics</h3><div class="keywords-list">';
        card.characteristics.forEach(c => {
        const suffix = c === 'Minion' && card.minion_limit ? `(${card.minion_limit})` : '';
        html += `<span class="keyword-tag characteristic">${c}${suffix}</span>`;
        });
        html += '</div></section>';
        }

        if (card.keywords && card.keywords.length > 0) {
        html += '<section><h3>Keywords</h3><div class="keywords-list">';
        card.keywords.forEach(k => {
        html += `<span class="keyword-tag">${k}</span>`;
        });
        html += '</div></section>';
        }

        html += '<section><h3>Info</h3>';
        html += `<p><strong>Faction:</strong> ${card.faction || 'Unknown'}</p>`;
        if (card.subfaction) html += `<p><strong>Subfaction:</strong> ${card.subfaction}</p>`;
        if (card.card_type) html += `<p><strong>Card Type:</strong> ${card.card_type === 'Stat' ? 'Model' : card.card_type}</p>`;
        if (card.base_size) html += `<p><strong>Base Size:</strong> ${card.base_size}</p>`;
        html += '</section>';

        details.innerHTML = html;
        }

        // Close modal on overlay click
        modalOverlay.onclick = closeModal;

        // Close modal on Escape key
        document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
        });

        // ===========================================
        // INITIALIZATION
        // ===========================================

        function populateFilters() {
        // Get unique factions
        const factions = [...new Set(allCards.map(c => c.faction).filter(Boolean))].sort();
        factions.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        factionSelect.appendChild(opt);
        });

        // Get unique base sizes
        const baseSizes = [...new Set(allCards.map(c => c.base_size).filter(Boolean))].sort((a, b) => {
        return parseInt(a) - parseInt(b);
        });
        baseSizes.forEach(size => {
        const opt = document.createElement('option');
        opt.value = size;
        opt.textContent = size;
        baseSizeSelect.appendChild(opt);
        });

        console.log('Populated filters - Factions:', factions.length, 'Base sizes:', baseSizes.length);
        }

        // Event listeners - trigger filtering on ANY change
        searchInput.addEventListener('input', applyFilters);
        factionSelect.addEventListener('change', applyFilters);
        baseSizeSelect.addEventListener('change', applyFilters);

        // Load data
        async function init() {
        try {
        console.log('Fetching card data...');

        // Try multiple possible locations for the data
        let data = null;
        const possiblePaths = [
        './data/cards.json',
        '/data/cards.json',
        'data/cards.json',
        '/Malifaux4eDB/data/cards.json'
        ];

        for (const path of possiblePaths) {
        try {
        console.log('Trying path:', path);
        const response = await fetch(path);
        if (response.ok) {
        data = await response.json();
        console.log('Successfully loaded from:', path);
        break;
        }
        } catch (e) {
        console.log('Failed to load from:', path);
        }
        }

        if (!data) {
        throw new Error('Could not load card data from any path');
        }

        allCards = data.cards || data || [];
        console.log('Loaded', allCards.length, 'cards');

        loadingEl.style.display = 'none';

        populateFilters();

        // Initial render - show ALL cards
        filteredCards = [...allCards];
        renderCards();

        } catch (error) {
        console.error('Failed to load cards:', error);
        loadingEl.textContent = 'Failed to load cards: ' + error.message;
        }
        }

        init();
    </script>
</body>
</html>