name: Build Data Pipeline

on:
  # Run on pushes to main that affect source data or pipeline
  push:
    branches: [main]
    paths:
      - 'data/raw/**'
      - 'pipeline/**'
      - 'build.py'
      - '.github/workflows/build-pipeline.yml'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all steps'
        required: false
        default: 'false'
        type: boolean

# Prevent concurrent builds
concurrency:
  group: build-pipeline
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          lfs: true  # Fetch Git LFS files (PDFs)
          fetch-depth: 0  # Full history for proper LFS checkout
      
      - name: Checkout images repository
        uses: actions/checkout@v4
        with:
          repository: profangrybeard/Malifaux4eDB-images
          path: Malifaux4eDB-images
          # If private repo, add: token: ${{ secrets.IMAGES_REPO_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify setup
        run: |
          echo "Python version:"
          python --version
          echo ""
          echo "Tesseract version:"
          tesseract --version
          echo ""
          echo "Checking directories:"
          echo "PDFs: $(find data/raw/card_pdfs -name '*.pdf' 2>/dev/null | wc -l) files"
          echo "Images: $(find Malifaux4eDB-images -name '*.png' 2>/dev/null | wc -l) files"
      
      - name: Run build pipeline
        run: |
          # Move images repo to expected sibling location for auto-detection
          # (build.py looks for ../Malifaux4eDB-images)
          mv Malifaux4eDB-images ../Malifaux4eDB-images
          
          # Run the build
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            python build.py --force
          else
            python build.py
          fi
      
      - name: Check build outputs
        run: |
          echo "Build outputs:"
          ls -la data/dist/
          echo ""
          echo "Card count:"
          python -c "import json; d=json.load(open('data/dist/cards.json')); print(f'Total cards: {len(d.get(\"cards\", []))}')"
          echo ""
          echo "Health extraction stats:"
          python -c "
          import json
          d=json.load(open('data/dist/cards.json'))
          cards = d.get('cards', [])
          with_health = sum(1 for c in cards if c.get('health') is not None)
          with_ss = sum(1 for c in cards if c.get('soulstone_cache'))
          print(f'Cards with health: {with_health}/{len(cards)}')
          print(f'Cards with soulstone_cache: {with_ss}')
          "
      
      - name: Copy to web app data directory
        run: |
          cp data/dist/*.json src/data/
          echo "Copied to src/data/:"
          ls -la src/data/
      
      - name: Commit updated data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if git diff --quiet src/data/; then
            echo "No changes to commit"
          else
            git add src/data/
            git commit -m "chore: update generated data files [skip ci]"
            git push
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            data/dist/
            data/intermediate/.build_state.json
          retention-days: 7
